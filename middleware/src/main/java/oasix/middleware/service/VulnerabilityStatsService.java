package oasix.middleware.service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import oasix.middleware.model.ServerState;
import oasix.middleware.model.Vulnerability;
import oasix.middleware.model.VulnerabilityStats;
import oasix.middleware.repository.VulnerabilityStatsRepository;

@Component
public class VulnerabilityStatsService {
	@Autowired
	VulnerabilityStatsRepository vulnerabilityStatsRepository;
		
	public void aggregate(ServerState serverState){
		List<VulnerabilityStats> stats = new ArrayList<>();
		
		Map<String, Integer> vulnerabilitiesMap = new HashMap<>();
		for(Vulnerability vulnerability : 	serverState.getVulnerabilities()){
			Integer count = vulnerabilitiesMap.get(vulnerability.getType());
			if(count==null || count == 0){
				vulnerabilitiesMap.put(vulnerability.getType(), 1);
			}else{
				vulnerabilitiesMap.put(vulnerability.getType(), count +1 );
			}
		}
		
		for(String type : vulnerabilitiesMap.keySet()){
			VulnerabilityStats vulnerabilityStats = new VulnerabilityStats(serverState.getHost(), serverState.getAnalysisDate(), vulnerabilitiesMap.get(type), type, "");
			stats.add(vulnerabilityStats);
		}
		
		vulnerabilityStatsRepository.save(stats);
	}
	
	public void cleanup() {
		vulnerabilityStatsRepository.delete(vulnerabilityStatsRepository.findAll());
	}
}
